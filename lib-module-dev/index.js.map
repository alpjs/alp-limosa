{"version":3,"sources":["../src/index.js"],"names":["RouterBuilder","RoutesTranslations","alpLimosa","routerBuilder","controllers","app","config","get","routeTranslations","routeTranslationsConfig","builder","router","context","urlGenerator","args","language","redirectTo","to","params","redirect","callAction","controllerName","actionName","route","controller","status","Error","action","Promise","resolve","call","err","reject","ctx","find","path"],"mappings":"AAAA;;AAEA,SAASA,aAAT,EAAwBC,kBAAxB,QAAkD,QAAlD;;;AAEA,SAASD,aAAT,QAA8B,QAA9B;;AAEA,eAAe,SAASE,SAAT,CAAmBC,aAAnB,EAA4CC,WAA5C,EAA8D;AAAA,2BAA9B,YAA8B;;AAAA,yBAAP,YAAO;;AAAA;AAAA;;AAC3E,SAAO,UAACC,GAAD,EAAS;AACd,QAAMC,SAASD,IAAIC,MAAnB;AACA,kCAA6B,YAA7B,QAAqCA,OAAOC,GAAP,CAAW,mBAAX,CAArC;AACA,QAAMC,oBAAoB,IAAIP,kBAAJ,CAAuBQ,uBAAvB,CAA1B;AACA,QAAMC,UAAU,IAAIV,aAAJ,CAAkBQ,iBAAlB,EAAqCF,OAAOC,GAAP,CAAW,oBAAX,CAArC,CAAhB;AACAJ,kBAAcO,OAAd;AACA,QAAMC,SAASD,QAAQC,MAAvB;;AAEAN,QAAIM,MAAJ,GAAaA,MAAb;;AAEAN,QAAIO,OAAJ,CAAYC,YAAZ,GAA2B,YAAmB;AAAA,wCAANC,IAAM;AAANA,YAAM;AAAA;;AAC5C,aAAOH,OAAOE,YAAP,gBAAoB,KAAKE,QAAzB,SAAsCD,IAAtC,EAAP;AACD,KAFD;;AAIAT,QAAIO,OAAJ,CAAYI,UAAZ,GAAyB,UAAUC,EAAV,EAAsBC,MAAtB,EAAuC;AAAA,oBAA3B,UAA2B;;AAAA,wBAAX,WAAG,UAAH,CAAW;;AAAA;AAAA;;AAC9D,aAAO,KAAKC,QAAL,CAAcR,OAAOE,YAAP,CAAoB,KAAKE,QAAzB,EAAmCE,EAAnC,EAAuCC,MAAvC,CAAd,CAAP;AACD,KAFD;;AAIAb,QAAID,WAAJ,GAAkBA,WAAlB;;AAQA;;;;;;AAMAC,QAAIO,OAAJ,CAAYQ,UAAZ,GAAyB,UAAUC,cAAV,EAAkCC,UAAlC,EAAuD;AAAA,gCAA/B,UAA+B;;AAAA,4BAAX,WAAG,UAAH,CAAW;;AAAA;AAAA;;AAC9E,UAAMC,QAAQ,KAAKA,KAAnB;;AAEA,UAAI,CAACD,UAAL,EAAiB;AACfA,4CAAaD,cAAb;AACAA,oDAAiBE,MAAMC,UAAvB;AACD;;AAED,UAAMA,aAAapB,YAAYG,GAAZ,CAAgBc,cAAhB,CAAnB;AACA,UAAI,CAACG,UAAL,EAAiB;AACf,aAAKC,MAAL,GAAc,GAAd;AACA,cAAM,IAAIC,KAAJ,4BAAmCL,cAAnC,CAAN;AACD;;AAED,UAAMM,SAASH,WAAWF,UAAX,CAAf;AACA,UAAI,CAACK,MAAL,CAAW,wBAAX,EAAqC;AACnC,eAAKF,MAAL,GAAc,GAAd;AACA,gBAAM,IAAIC,KAAJ,wBAA+BH,MAAMC,UAArC,SAAmDD,MAAMI,MAAzD,CAAN;AACD;;AAED,UAAI;AACF,eAAOC,QAAQC,OAAR,CAAgBL,WAAWF,UAAX,EAAuBQ,IAAvB,CAA4B,IAA5B,EAAkC,IAAlC,CAAhB,CAAP;AACD,OAFD,CAEE,OAAOC,GAAP,EAAY;AACZ,eAAOH,QAAQI,MAAR,CAAeD,GAAf,CAAP;AACD;AACF,KAzBD;;AA2BA,WAAO,UAACE,GAAD,EAAS;AACd,UAAIV,QAAQZ,OAAOuB,IAAP,CAAYD,IAAIE,IAAhB,EAAsBF,IAAIlB,QAA1B,CAAZ;;AAEA,UAAI,CAACQ,KAAL,EAAY;AACVU,YAAIR,MAAJ,GAAa,GAAb;AACA,cAAM,IAAIC,KAAJ,uBAA8BO,IAAIE,IAAlC,CAAN;AACD;;AAEDF,UAAIV,KAAJ,GAAYA,KAAZ;;AAEA,aAAOU,IAAIb,UAAJ,CAAeG,MAAMC,UAArB,EAAiCD,MAAMI,MAAvC,CAAP;AACD,KAXD;AAYD,GAvED;AAwED","file":"index.js","sourcesContent":["/* global BROWSER */\n\nimport { RouterBuilder, RoutesTranslations } from 'limosa';\n\nexport { RouterBuilder } from 'limosa';\n\nexport default function alpLimosa(routerBuilder: Function, controllers: Map) {\n  return (app) => {\n    const config = app.config;\n    const routeTranslationsConfig: Map = config.get('routeTranslations');\n    const routeTranslations = new RoutesTranslations(routeTranslationsConfig);\n    const builder = new RouterBuilder(routeTranslations, config.get('availableLanguages'));\n    routerBuilder(builder);\n    const router = builder.router;\n\n    app.router = router;\n\n    app.context.urlGenerator = function (...args) {\n      return router.urlGenerator(this.language, ...args);\n    };\n\n    app.context.redirectTo = function (to: string, params: ?Object) {\n      return this.redirect(router.urlGenerator(this.language, to, params));\n    };\n\n    app.controllers = controllers;\n\n    if (!BROWSER) {\n      app.registerBrowserContextTransformer((initialBrowserContext, ctx) => (\n        initialBrowserContext.route = ctx.route\n      ));\n    }\n\n    /**\n     *\n     * @param {string} controllerName\n     * @param {string} [actionName]\n     * @returns {*}\n     */\n    app.context.callAction = function (controllerName: string, actionName: ?string) {\n      const route = this.route;\n\n      if (!actionName) {\n        actionName = controllerName;\n        controllerName = route.controller;\n      }\n\n      const controller = controllers.get(controllerName);\n      if (!controller) {\n        this.status = 404;\n        throw new Error(`Controller not found: ${controllerName}`);\n      }\n\n      const action = controller[actionName];\n      if (!action/* || !action.isAction*/) {\n        this.status = 404;\n        throw new Error(`Action not found: ${route.controller}.${route.action}`);\n      }\n\n      try {\n        return Promise.resolve(controller[actionName].call(null, this));\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    };\n\n    return (ctx) => {\n      let route = router.find(ctx.path, ctx.language);\n\n      if (!route) {\n        ctx.status = 404;\n        throw new Error(`Route not found: ${ctx.path}`);\n      }\n\n      ctx.route = route;\n\n      return ctx.callAction(route.controller, route.action);\n    };\n  };\n}\n"]}